/**
 * Next.js ä¸­é—´ä»¶é…ç½®
 * 
 * ç»Ÿä¸€å¤„ç†æ‰€æœ‰è¯·æ±‚çš„è®¤è¯ã€æ—¥å¿—ã€é™æµç­‰
 */

import { NextRequest, NextResponse } from 'next/server';
import { authMiddleware } from './middleware/auth';

// éœ€è¦è®¤è¯çš„APIè·¯å¾„
const PROTECTED_API_PATHS = [
  '/api/enterprises',
  '/api/groups',
  '/api/permissions',
  '/api/user',
  '/api/ai-accounts'
];

// å…¬å¼€APIè·¯å¾„ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
const PUBLIC_API_PATHS = [
  '/api/auth/login',
  '/api/auth/register', 
  '/api/auth/refresh',
  '/api/auth/logout',
  '/api/health',
  '/api/status',
  '/api/public'
];

// éœ€è¦è®¤è¯çš„é¡µé¢è·¯å¾„
const PROTECTED_PAGE_PATHS = [
  '/dashboard',
  '/enterprise',
  '/groups',
  '/permissions',
  '/settings'
];

/**
 * ä¸»ä¸­é—´ä»¶å‡½æ•°
 */
export async function middleware(request: NextRequest) {
  const pathname = request.nextUrl.pathname;
  
  // è®°å½•è¯·æ±‚æ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  if (process.env.NODE_ENV === 'development') {
    console.log(`ğŸ“ [${new Date().toISOString()}] ${request.method} ${pathname}`);
  }
  
  // APIè·¯å¾„è®¤è¯å¤„ç†
  if (pathname.startsWith('/api/')) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯å…¬å¼€API
    const isPublicApi = PUBLIC_API_PATHS.some(path => pathname.startsWith(path));
    
    if (!isPublicApi) {
      // åº”ç”¨è®¤è¯ä¸­é—´ä»¶
      return authMiddleware(request);
    }
  }
  
  // é¡µé¢è·¯å¾„è®¤è¯å¤„ç†
  if (PROTECTED_PAGE_PATHS.some(path => pathname.startsWith(path))) {
    // æ£€æŸ¥æ˜¯å¦æœ‰tokenï¼ˆä»cookieæˆ–localStorageï¼‰
    const token = request.cookies.get('token')?.value;
    
    if (!token) {
      // é‡å®šå‘åˆ°ç™»å½•é¡µ
      const url = request.nextUrl.clone();
      url.pathname = '/login';
      url.searchParams.set('redirect', pathname);
      return NextResponse.redirect(url);
    }
    
    // TODO: éªŒè¯tokenæœ‰æ•ˆæ€§
    // è¿™é‡Œå¯ä»¥æ·»åŠ tokenéªŒè¯é€»è¾‘
  }
  
  // CORSå¤„ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
  if (request.method === 'OPTIONS') {
    return new NextResponse(null, {
      status: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Access-Control-Max-Age': '86400',
      },
    });
  }
  
  // æ·»åŠ å®‰å…¨å“åº”å¤´
  const response = NextResponse.next();
  
  // å®‰å…¨å“åº”å¤´
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  // åœ¨å¼€å‘ç¯å¢ƒæ·»åŠ CORSå¤´
  if (process.env.NODE_ENV === 'development') {
    response.headers.set('Access-Control-Allow-Origin', '*');
  }
  
  return response;
}

/**
 * é…ç½®ä¸­é—´ä»¶åŒ¹é…è§„åˆ™
 */
export const config = {
  matcher: [
    /*
     * åŒ¹é…æ‰€æœ‰è·¯å¾„é™¤äº†:
     * - _next/static (é™æ€æ–‡ä»¶)
     * - _next/image (å›¾ç‰‡ä¼˜åŒ–)
     * - favicon.ico (ç½‘ç«™å›¾æ ‡)
     * - publicæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
     */
    '/((?!_next/static|_next/image|favicon.ico|public/).*)',
  ]
};