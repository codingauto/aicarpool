name: æµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: aicarpool_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ”§ è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ðŸ” éªŒè¯æµ‹è¯•çŽ¯å¢ƒ
      run: node scripts/verify-test-env.js
    
    - name: ðŸ—„ï¸ è¿è¡Œæ•°æ®åº“è¿ç§»
      env:
        DATABASE_URL: mysql://root:root@localhost:3306/aicarpool_test
      run: |
        npx prisma migrate deploy
        npx prisma db seed
      continue-on-error: true
    
    - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      env:
        NODE_ENV: test
        DATABASE_URL: mysql://root:root@localhost:3306/aicarpool_test
        REDIS_URL: redis://localhost:6379/1
        JWT_SECRET: test-jwt-secret-key
        JWT_REFRESH_SECRET: test-jwt-refresh-secret
      run: npm run test -- --ci --coverage --maxWorkers=2
    
    - name: ðŸ“Š ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: ðŸ“ˆ ä¸Šä¼ è¦†ç›–çŽ‡åˆ° Coveralls
      if: matrix.node-version == '20.x'
      uses: coverallsapp/github-action@v2
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: ./coverage/lcov.info
      continue-on-error: true
    
    - name: ðŸ’¾ ä¸Šä¼ æµ‹è¯•ç»“æžœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.node-version }}
        path: |
          coverage/
          test-results/
        retention-days: 7
    
    - name: ðŸ“ æµ‹è¯•æŠ¥å‘Šæ€»ç»“
      if: always()
      run: |
        echo "## æµ‹è¯•ç»“æžœæ€»ç»“ ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Nodeç‰ˆæœ¬: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- æµ‹è¯•çŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f coverage/coverage-summary.json ]; then
          echo "### è¦†ç›–çŽ‡ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.json | jq '.total' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ”§ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ðŸŽ¨ è¿è¡Œ ESLint
      run: npm run lint
      continue-on-error: true
    
    - name: ðŸ“ è¿è¡Œ Prettier æ£€æŸ¥
      run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"
      continue-on-error: true
    
    - name: ðŸ” TypeScript ç±»åž‹æ£€æŸ¥
      run: npm run typecheck
      continue-on-error: true

  test-summary:
    name: æµ‹è¯•æ€»ç»“
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š ç”Ÿæˆæµ‹è¯•æ€»ç»“
      run: |
        echo "# AiCarpool æµ‹è¯•æµæ°´çº¿æ€»ç»“ ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| å•å…ƒæµ‹è¯• | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ä»£ç æ£€æŸ¥ | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "è§¦å‘è€…: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY