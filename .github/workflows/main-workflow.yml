name: ğŸš€ Main CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  # Node.jsè®¾ç½®
  NODE_VERSION: '22'
  # Dockerè®¾ç½®
  REGISTRY: docker.io
  IMAGE_NAME: wutongci/aicarpool
  # æ•°æ®åº“å ä½ç¬¦URLï¼ˆç”¨äºé€šè¿‡PrismaéªŒè¯ï¼‰
  DATABASE_URL: mysql://root:password@localhost:3306/test_db
  # å…¶ä»–ç¯å¢ƒå˜é‡
  REDIS_URL: redis://localhost:6379
  JWT_SECRET: test-jwt-secret-for-ci
  ENCRYPTION_KEY: test-encryption-key-32-characters

jobs:
  # ğŸ§ª ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  quality-check:
    name: ğŸ§ª Code Quality & Tests
    runs-on: ubuntu-latest
    
    # æ³¨é‡Šæ‰æ•°æ®åº“æœåŠ¡ï¼Œå› ä¸ºç›®å‰æ²¡æœ‰å®é™…çš„æ•°æ®åº“
    # å½“æœ‰æ•°æ®åº“æ—¶ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Š
    # services:
    #   mysql:
    #     image: mysql:8.0
    #     env:
    #       MYSQL_ROOT_PASSWORD: test
    #       MYSQL_USER: test
    #       MYSQL_PASSWORD: test
    #       MYSQL_DATABASE: aicarpool_test
    #     options: >-
    #       --health-cmd="mysqladmin ping"
    #       --health-interval=10s
    #       --health-timeout=5s
    #       --health-retries=5
    #     ports:
    #       - 3306:3306
    #   
    #   redis:
    #     image: redis:7
    #     options: >-
    #       --health-cmd "redis-cli ping"
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5
    #     ports:
    #       - 6379:6379
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Generate Prisma Client
        run: |
          echo "Generating Prisma Client..."
          DATABASE_URL="${{ env.DATABASE_URL }}" npx prisma generate
        continue-on-error: true

      - name: ğŸ” Run ESLint
        run: npm run lint || true
        continue-on-error: true

      - name: ğŸ” Run TypeScript check
        run: npm run type-check || true
        continue-on-error: true

      - name: ğŸ—ï¸ Test build process
        run: |
          DATABASE_URL="${{ env.DATABASE_URL }}" npm run build
        env:
          SKIP_ENV_VALIDATION: true
        continue-on-error: true

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

      # æ•°æ®åº“æµ‹è¯•ï¼ˆå½“å‰è·³è¿‡ï¼‰
      - name: â­ï¸ Skip Database Tests
        run: |
          echo "âš ï¸ Skipping database tests - no database configured"
          echo "When database is available, uncomment the services section above"

      # å½“æœ‰æ•°æ®åº“æ—¶ï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹æµ‹è¯•
      # - name: ğŸ§ª Run unit tests
      #   run: npm test
      #   continue-on-error: true
      
      # - name: ğŸš€ Run performance tests
      #   run: npx tsx scripts/performance-test.ts http://localhost:4000 test-key 5 50
      #   continue-on-error: true

  # ğŸ”’ å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ” Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true
      
      - name: ğŸ“Š Check for dependency updates
        run: npx npm-check-updates
        continue-on-error: true

  # ğŸ³ æ„å»ºå’Œæ¨é€Dockeré•œåƒ
  docker:
    name: ğŸ³ Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # set latest tag for default branch
            type=raw,value=latest,enable={{is_default_branch}}
            # set develop tag for develop branch
            type=raw,value=dev,enable=${{ github.ref == format('refs/heads/{0}', 'develop') }}
            # version tags for releases
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # for PRs: pr-<number>-<short-sha>
            type=ref,event=pr,prefix=pr-,suffix=-{{sha}}
            # for branches: branch-<name>-<short-sha>
            type=ref,event=branch,prefix=branch-,suffix=-{{sha}}
          labels: |
            org.opencontainers.image.title=AiCarpool
            org.opencontainers.image.description=Enterprise AI Service Carpool Management Platform
            org.opencontainers.image.vendor=CodingAuto
            org.opencontainers.image.licenses=MIT

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            NEXT_TELEMETRY_DISABLED=1

      - name: ğŸ“ Generate Docker image summary
        if: github.event_name != 'pull_request'
        run: |
          echo "## ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.meta.outputs.tags }}' | sed 's/^/- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Pull and run the latest image" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  --name aicarpool \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 4000:4000 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e DATABASE_URL=\"mysql://user:pass@host:3306/aicarpool\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e NEXTAUTH_SECRET=\"your-secret\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or use docker-compose" >> $GITHUB_STEP_SUMMARY
          echo "wget https://raw.githubusercontent.com/codingauto/aicarpool/main/docker-compose.yml" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ğŸ” Dockeré•œåƒå®‰å…¨æ‰«æ
  docker-security:
    name: ğŸ” Docker Security Scan
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name != 'pull_request'
    permissions:
      security-events: write
    
    steps:
      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # ğŸ“‹ æ›´æ–°Docker Hubæè¿°
  update-docker-description:
    name: ğŸ“‹ Update Docker Hub Description
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“ Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.IMAGE_NAME }}
          readme-filepath: ./README.md
        continue-on-error: true

  # ğŸš€ éƒ¨ç½²åˆ°Stagingç¯å¢ƒ
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [quality-check, docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev"
          # åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²å‘½ä»¤
          # ä¾‹å¦‚: kubectl set image deployment/aicarpool aicarpool=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
        continue-on-error: true

  # ğŸ¯ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-check, docker, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ¯ Deploy to Production
        run: |
          echo "ğŸ¯ Deploying to production environment..."
          echo "Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          # åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²å‘½ä»¤
          # ä¾‹å¦‚: kubectl set image deployment/aicarpool aicarpool=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        continue-on-error: true

  # â¤ï¸ å¥åº·æ£€æŸ¥
  health-check:
    name: â¤ï¸ Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: â¤ï¸ Check Application Health
        run: |
          echo "Checking application health..."
          # åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„å¥åº·æ£€æŸ¥
          # curl -f https://your-app-url/api/health || exit 1
        continue-on-error: true
      
      - name: ğŸ“Š Check Metrics Endpoint
        run: |
          echo "Checking metrics endpoint..."
          # åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„æŒ‡æ ‡æ£€æŸ¥
          # curl -f https://your-app-url/api/metrics || exit 1
        continue-on-error: true

  # ğŸ“Š å·¥ä½œæµæ‘˜è¦
  workflow-summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, docker]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate workflow summary
        run: |
          echo "## ğŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Quality Check: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ${{ needs.docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY