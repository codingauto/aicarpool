# JWTå·¥å…·å‡½æ•°æµ‹è¯•è®¡åˆ’

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ–‡ä»¶è·¯å¾„**: `src/lib/auth/jwt-utils.ts`

**åŠŸèƒ½æè¿°**: 
JWTå·¥å…·æ¨¡å—è´Ÿè´£å¤„ç†æ‰€æœ‰JWTä»¤ç‰Œç›¸å…³æ“ä½œï¼ŒåŒ…æ‹¬ç”Ÿæˆã€éªŒè¯ã€åˆ·æ–°å’Œè§£ç ã€‚è¿™æ˜¯ç³»ç»Ÿè®¤è¯çš„æ ¸å¿ƒç»„ä»¶ï¼Œç›´æ¥å½±å“ç”¨æˆ·èº«ä»½éªŒè¯å’Œä¼šè¯ç®¡ç†ã€‚

**é‡è¦æ€§**: ğŸ”´ **æé«˜** - å®‰å…¨å…³é”®æ¨¡å—ï¼Œä»»ä½•ç¼ºé™·å¯èƒ½å¯¼è‡´è®¤è¯ç»•è¿‡æˆ–æœªæˆæƒè®¿é—®

## ğŸ¯ æµ‹è¯•èŒƒå›´

### éœ€è¦æµ‹è¯•çš„å‡½æ•°

| å‡½æ•°å | ä¼˜å…ˆçº§ | åŠŸèƒ½æè¿° |
|--------|--------|----------|
| `generateToken()` | é«˜ | ç”ŸæˆJWTè®¿é—®ä»¤ç‰Œ |
| `verifyToken()` | é«˜ | éªŒè¯JWTä»¤ç‰Œæœ‰æ•ˆæ€§ |
| `decodeToken()` | ä¸­ | è§£ç JWTä»¤ç‰Œï¼ˆä¸éªŒè¯ï¼‰ |
| `generateTokenPair()` | é«˜ | ç”Ÿæˆè®¿é—®/åˆ·æ–°ä»¤ç‰Œå¯¹ |
| `refreshAccessToken()` | é«˜ | ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°è®¿é—®ä»¤ç‰Œ |
| `verifyRefreshToken()` | é«˜ | éªŒè¯åˆ·æ–°ä»¤ç‰Œ |
| `revokeToken()` | ä¸­ | æ’¤é”€ä»¤ç‰Œï¼ˆé»‘åå•ï¼‰ |
| `extractUserId()` | ä½ | ä»ä»¤ç‰Œæå–ç”¨æˆ·ID |

## ğŸ“ è¯¦ç»†æµ‹è¯•ç”¨ä¾‹

### 1. generateToken() æµ‹è¯•

```typescript
describe('generateToken', () => {
  // æ­£å¸¸åœºæ™¯
  it('åº”è¯¥ç”Ÿæˆæœ‰æ•ˆçš„JWTä»¤ç‰Œ', () => {
    // è¾“å…¥: ç”¨æˆ·payload
    // æœŸæœ›: è¿”å›ç¬¦åˆJWTæ ¼å¼çš„å­—ç¬¦ä¸²
  });

  it('åº”è¯¥åŒ…å«æ‰€æœ‰å¿…è¦çš„payloadå­—æ®µ', () => {
    // è¾“å…¥: å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
    // æœŸæœ›: ä»¤ç‰ŒåŒ…å«userId, email, role, enterpriseId
  });

  it('åº”è¯¥è®¾ç½®æ­£ç¡®çš„è¿‡æœŸæ—¶é—´', () => {
    // è¾“å…¥: è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´
    // æœŸæœ›: ä»¤ç‰Œåœ¨æŒ‡å®šæ—¶é—´åè¿‡æœŸ
  });

  // è¾¹ç•Œæ¡ä»¶
  it('åº”è¯¥å¤„ç†ç©ºpayload', () => {
    // è¾“å…¥: ç©ºå¯¹è±¡
    // æœŸæœ›: æŠ›å‡ºé”™è¯¯æˆ–è¿”å›åŸºç¡€ä»¤ç‰Œ
  });

  it('åº”è¯¥å¤„ç†è¶…é•¿payload', () => {
    // è¾“å…¥: å¤§é‡æ•°æ®
    // æœŸæœ›: æ­£å¸¸ç”Ÿæˆæˆ–é™åˆ¶å¤§å°
  });

  // å®‰å…¨æµ‹è¯•
  it('ä¸åº”è¯¥åœ¨ä»¤ç‰Œä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯', () => {
    // è¾“å…¥: åŒ…å«å¯†ç çš„payload
    // æœŸæœ›: è¿‡æ»¤æ•æ„Ÿå­—æ®µ
  });
});
```

### 2. verifyToken() æµ‹è¯•

```typescript
describe('verifyToken', () => {
  // æ­£å¸¸åœºæ™¯
  it('åº”è¯¥æˆåŠŸéªŒè¯æœ‰æ•ˆä»¤ç‰Œ', () => {
    // è¾“å…¥: åˆšç”Ÿæˆçš„æœ‰æ•ˆä»¤ç‰Œ
    // æœŸæœ›: è¿”å›è§£ç çš„payload
  });

  it('åº”è¯¥æ‹’ç»è¿‡æœŸä»¤ç‰Œ', () => {
    // è¾“å…¥: è¿‡æœŸçš„ä»¤ç‰Œ
    // æœŸæœ›: è¿”å›nullæˆ–æŠ›å‡ºé”™è¯¯
  });

  it('åº”è¯¥æ‹’ç»ç¯¡æ”¹çš„ä»¤ç‰Œ', () => {
    // è¾“å…¥: ä¿®æ”¹è¿‡çš„ä»¤ç‰Œ
    // æœŸæœ›: éªŒè¯å¤±è´¥
  });

  // é”™è¯¯å¤„ç†
  it('åº”è¯¥å¤„ç†æ— æ•ˆçš„ä»¤ç‰Œæ ¼å¼', () => {
    // è¾“å…¥: æ ¼å¼é”™è¯¯çš„å­—ç¬¦ä¸²
    // æœŸæœ›: è¿”å›nullï¼Œä¸å´©æºƒ
  });

  it('åº”è¯¥å¤„ç†é”™è¯¯çš„ç­¾å', () => {
    // è¾“å…¥: ä½¿ç”¨é”™è¯¯å¯†é’¥ç­¾åçš„ä»¤ç‰Œ
    // æœŸæœ›: éªŒè¯å¤±è´¥
  });

  // æ€§èƒ½æµ‹è¯•
  it('åº”è¯¥åœ¨åˆç†æ—¶é—´å†…éªŒè¯ä»¤ç‰Œ', () => {
    // è¾“å…¥: 1000ä¸ªä»¤ç‰Œ
    // æœŸæœ›: < 100mså®Œæˆ
  });
});
```

### 3. generateTokenPair() æµ‹è¯•

```typescript
describe('generateTokenPair', () => {
  it('åº”è¯¥ç”Ÿæˆè®¿é—®å’Œåˆ·æ–°ä»¤ç‰Œ', () => {
    // æœŸæœ›: è¿”å›åŒ…å«ä¸¤ä¸ªä»¤ç‰Œçš„å¯¹è±¡
  });

  it('åˆ·æ–°ä»¤ç‰Œåº”è¯¥æ¯”è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸé•¿', () => {
    // æœŸæœ›: refreshTokenè¿‡æœŸæ—¶é—´ > accessTokenè¿‡æœŸæ—¶é—´
  });

  it('ä¸¤ä¸ªä»¤ç‰Œåº”è¯¥åŒ…å«ç›¸åŒçš„ç”¨æˆ·ä¿¡æ¯', () => {
    // æœŸæœ›: è§£ç åuserIdä¸€è‡´
  });
});
```

### 4. refreshAccessToken() æµ‹è¯•

```typescript
describe('refreshAccessToken', () => {
  it('åº”è¯¥ä½¿ç”¨æœ‰æ•ˆåˆ·æ–°ä»¤ç‰Œç”Ÿæˆæ–°è®¿é—®ä»¤ç‰Œ', () => {
    // è¾“å…¥: æœ‰æ•ˆçš„refreshToken
    // æœŸæœ›: è¿”å›æ–°çš„accessToken
  });

  it('åº”è¯¥ä¿æŒç”¨æˆ·ä¿¡æ¯ä¸å˜', () => {
    // æœŸæœ›: æ–°ä»¤ç‰ŒåŒ…å«ç›¸åŒçš„userIdå’Œrole
  });

  it('åº”è¯¥æ›´æ–°ä»¤ç‰Œçš„ç­¾å‘æ—¶é—´', () => {
    // æœŸæœ›: iatå­—æ®µæ›´æ–°
  });

  it('åº”è¯¥æ‹’ç»å·²æ’¤é”€çš„åˆ·æ–°ä»¤ç‰Œ', () => {
    // è¾“å…¥: é»‘åå•ä¸­çš„ä»¤ç‰Œ
    // æœŸæœ›: æ‹’ç»åˆ·æ–°
  });
});
```

## ğŸ”§ Mockç­–ç•¥

### éœ€è¦Mockçš„ä¾èµ–

1. **ç¯å¢ƒå˜é‡**
   ```typescript
   process.env.JWT_SECRET = 'test-secret';
   process.env.JWT_REFRESH_SECRET = 'test-refresh-secret';
   ```

2. **Prismaå®¢æˆ·ç«¯**
   ```typescript
   jest.mock('@/lib/prisma', () => ({
     prisma: {
       user: {
         findUnique: jest.fn(),
         update: jest.fn()
       },
       tokenBlacklist: {
         create: jest.fn(),
         findFirst: jest.fn()
       }
     }
   }));
   ```

3. **Rediså®¢æˆ·ç«¯**
   ```typescript
   jest.mock('@/lib/redis', () => ({
     redisClient: {
       set: jest.fn(),
       get: jest.fn(),
       del: jest.fn(),
       expire: jest.fn()
     }
   }));
   ```

## ğŸ” è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†

### è¾¹ç•Œæ¡ä»¶æµ‹è¯•

1. **æ—¶é—´è¾¹ç•Œ**
   - ä»¤ç‰Œåˆšå¥½è¿‡æœŸçš„ç¬é—´
   - ä»¤ç‰Œå³å°†è¿‡æœŸï¼ˆ< 1åˆ†é’Ÿï¼‰
   - ç³»ç»Ÿæ—¶é—´è¢«ä¿®æ”¹çš„æƒ…å†µ

2. **æ•°æ®è¾¹ç•Œ**
   - ç©ºå­—ç¬¦ä¸²è¾“å…¥
   - è¶…é•¿å­—ç¬¦ä¸²ï¼ˆ> 8KBï¼‰
   - ç‰¹æ®Šå­—ç¬¦å’ŒUnicode

3. **å¹¶å‘è¾¹ç•Œ**
   - åŒæ—¶éªŒè¯å¤šä¸ªä»¤ç‰Œ
   - ä»¤ç‰Œåˆ·æ–°ç«æ€æ¡ä»¶

### é”™è¯¯åœºæ™¯

```typescript
describe('é”™è¯¯å¤„ç†', () => {
  it('åº”è¯¥ä¼˜é›…å¤„ç†å¯†é’¥ä¸¢å¤±', () => {
    // åˆ é™¤JWT_SECRET
    // æœŸæœ›: æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
  });

  it('åº”è¯¥å¤„ç†base64è§£ç é”™è¯¯', () => {
    // è¾“å…¥: æ ¼å¼é”™è¯¯çš„base64
    // æœŸæœ›: è¿”å›nullï¼Œè®°å½•é”™è¯¯
  });

  it('åº”è¯¥å¤„ç†JSONè§£æé”™è¯¯', () => {
    // è¾“å…¥: æ— æ•ˆçš„JSON payload
    // æœŸæœ›: å®‰å…¨å¤±è´¥
  });
});
```

## âš¡ æ€§èƒ½æµ‹è¯•

```typescript
describe('æ€§èƒ½æµ‹è¯•', () => {
  it('ç”Ÿæˆä»¤ç‰Œåº”è¯¥ < 10ms', async () => {
    const start = Date.now();
    generateToken(payload);
    expect(Date.now() - start).toBeLessThan(10);
  });

  it('éªŒè¯ä»¤ç‰Œåº”è¯¥ < 5ms', async () => {
    const token = generateToken(payload);
    const start = Date.now();
    verifyToken(token);
    expect(Date.now() - start).toBeLessThan(5);
  });

  it('åº”è¯¥èƒ½å¤„ç†é«˜å¹¶å‘', async () => {
    const promises = Array(1000).fill(null).map(() => 
      generateToken(payload)
    );
    const results = await Promise.all(promises);
    expect(results).toHaveLength(1000);
  });
});
```

## âœ… éªŒæ”¶æ ‡å‡†

### è¦†ç›–ç‡è¦æ±‚
- è¯­å¥è¦†ç›–ç‡: â‰¥ 95%
- åˆ†æ”¯è¦†ç›–ç‡: â‰¥ 90%
- å‡½æ•°è¦†ç›–ç‡: 100%
- è¡Œè¦†ç›–ç‡: â‰¥ 95%

### è´¨é‡æ ‡å‡†
- æ‰€æœ‰æµ‹è¯•å¿…é¡»ç‹¬ç«‹è¿è¡Œ
- æµ‹è¯•æ‰§è¡Œæ—¶é—´ < 500ms
- æ— ç¡¬ç¼–ç çš„å¯†é’¥æˆ–ä»¤ç‰Œ
- åŒ…å«æ­£å¸¸ã€å¼‚å¸¸ã€è¾¹ç•Œåœºæ™¯

### å®‰å…¨è¦æ±‚
- æµ‹è¯•ä¸èƒ½æ³„éœ²çœŸå®å¯†é’¥
- å¿…é¡»æµ‹è¯•ä»¤ç‰Œç¯¡æ”¹åœºæ™¯
- éªŒè¯è¿‡æœŸæ—¶é—´å¤„ç†
- æµ‹è¯•æ’¤é”€æœºåˆ¶

## ğŸ“š æµ‹è¯•æ•°æ®å‡†å¤‡

```typescript
// test-data/jwt-test-data.ts
export const testUsers = {
  normal: {
    userId: 'user-123',
    email: 'test@example.com',
    role: 'user',
    enterpriseId: 'ent-456'
  },
  admin: {
    userId: 'admin-789',
    email: 'admin@example.com',
    role: 'admin',
    enterpriseId: 'ent-456'
  }
};

export const testTokens = {
  valid: 'eyJhbGciOiJIUzI1NiIs...',
  expired: 'eyJhbGciOiJIUzI1NiIs...',
  invalid: 'invalid.token.string',
  tampered: 'eyJhbGciOiJIUzI1NiIs...'
};
```

## ğŸš€ å®æ–½æ­¥éª¤

1. **ç¬¬1å¤©**: ç¼–å†™åŸºç¡€æµ‹è¯•ç»“æ„å’ŒMockè®¾ç½®
2. **ç¬¬2å¤©**: å®ç°generateTokenå’ŒverifyTokenæµ‹è¯•
3. **ç¬¬3å¤©**: å®ç°ä»¤ç‰Œå¯¹å’Œåˆ·æ–°é€»è¾‘æµ‹è¯•
4. **ç¬¬4å¤©**: æ·»åŠ è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†æµ‹è¯•
5. **ç¬¬5å¤©**: æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

## ğŸ“ˆ é£é™©å’Œç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| å¯†é’¥æ³„éœ² | é«˜ | ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸ç¡¬ç¼–ç  |
| æ—¶é—´ä¾èµ– | ä¸­ | ä½¿ç”¨jest.useFakeTimers() |
| å¹¶å‘é—®é¢˜ | ä¸­ | æ·»åŠ å¹¶å‘æµ‹è¯•åœºæ™¯ |
| Mockå¤æ‚åº¦ | ä½ | åˆ›å»ºå¯é‡ç”¨çš„Mockå·¥å…· |

---

*åˆ›å»ºæ—¥æœŸ: 2025-01-12*
*è´Ÿè´£äºº: è®¤è¯æµ‹è¯•å°ç»„*
*ä¸‹æ¬¡è¯„å®¡: 2025-01-19*