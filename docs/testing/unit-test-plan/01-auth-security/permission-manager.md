# æƒé™ç®¡ç†æµ‹è¯•è®¡åˆ’

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ–‡ä»¶è·¯å¾„**: 
- `src/lib/enterprise/permission-manager.ts`
- `src/lib/permission/simple-permission-manager.ts`
- `src/lib/enterprise-permissions.ts`

**åŠŸèƒ½æè¿°**: 
æƒé™ç®¡ç†ç³»ç»Ÿè´Ÿè´£æ§åˆ¶ç”¨æˆ·å¯¹èµ„æºçš„è®¿é—®æƒé™ï¼ŒåŒ…æ‹¬è§’è‰²å®šä¹‰ã€æƒé™åˆ†é…ã€æƒé™éªŒè¯ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚æ”¯æŒä¼ä¸šçº§çš„ç»†ç²’åº¦æƒé™æ§åˆ¶ã€‚

**é‡è¦æ€§**: ğŸ”´ **æé«˜** - ç›´æ¥å½±å“ç³»ç»Ÿå®‰å…¨æ€§å’Œæ•°æ®éš”ç¦»

## ğŸ¯ æµ‹è¯•èŒƒå›´

### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ç‚¹

| åŠŸèƒ½æ¨¡å— | ä¼˜å…ˆçº§ | æµ‹è¯•é‡ç‚¹ |
|---------|--------|----------|
| æƒé™éªŒè¯ | é«˜ | checkPermission(), hasPermission() |
| è§’è‰²ç®¡ç† | é«˜ | assignRole(), removeRole(), getRoles() |
| æƒé™åˆ†é… | é«˜ | grantPermission(), revokePermission() |
| æƒé™ç»§æ‰¿ | ä¸­ | è§’è‰²å±‚çº§ï¼Œæƒé™ä¼ é€’ |
| æƒé™ç¼“å­˜ | ä¸­ | ç¼“å­˜æœ‰æ•ˆæ€§ï¼Œæ›´æ–°æœºåˆ¶ |
| æ‰¹é‡æ“ä½œ | ä½ | æ‰¹é‡æˆæƒï¼Œæ‰¹é‡æ’¤é”€ |

## ğŸ“ è¯¦ç»†æµ‹è¯•ç”¨ä¾‹

### 1. æƒé™éªŒè¯æµ‹è¯•

```typescript
describe('PermissionManager - æƒé™éªŒè¯', () => {
  describe('checkPermission', () => {
    it('åº”è¯¥å…è®¸æœ‰æƒé™çš„ç”¨æˆ·è®¿é—®èµ„æº', () => {
      // å‡†å¤‡: ç”¨æˆ·æœ‰ 'read:users' æƒé™
      // åŠ¨ä½œ: checkPermission(userId, 'read:users')
      // æœŸæœ›: è¿”å› true
    });

    it('åº”è¯¥æ‹’ç»æ— æƒé™çš„ç”¨æˆ·è®¿é—®', () => {
      // å‡†å¤‡: ç”¨æˆ·æ²¡æœ‰ 'delete:users' æƒé™
      // åŠ¨ä½œ: checkPermission(userId, 'delete:users')
      // æœŸæœ›: è¿”å› false
    });

    it('åº”è¯¥æ”¯æŒé€šé…ç¬¦æƒé™', () => {
      // å‡†å¤‡: ç”¨æˆ·æœ‰ 'admin:*' æƒé™
      // åŠ¨ä½œ: checkPermission(userId, 'admin:users')
      // æœŸæœ›: è¿”å› true
    });

    it('åº”è¯¥éªŒè¯èµ„æºçº§æƒé™', () => {
      // å‡†å¤‡: ç”¨æˆ·æœ‰ç‰¹å®šèµ„æºæƒé™
      // åŠ¨ä½œ: checkPermission(userId, 'edit:user:123')
      // æœŸæœ›: æ­£ç¡®éªŒè¯èµ„æºID
    });

    it('åº”è¯¥å¤„ç†æƒé™ç»§æ‰¿', () => {
      // å‡†å¤‡: adminè§’è‰²åŒ…å«æ‰€æœ‰useræƒé™
      // åŠ¨ä½œ: ç”¨æˆ·æ˜¯adminï¼Œæ£€æŸ¥useræƒé™
      // æœŸæœ›: ç»§æ‰¿çš„æƒé™ç”Ÿæ•ˆ
    });
  });

  describe('hasPermission - æ‰¹é‡æƒé™æ£€æŸ¥', () => {
    it('åº”è¯¥æ”¯æŒANDé€»è¾‘', () => {
      // è¾“å…¥: ['read:users', 'write:users'], operator: 'AND'
      // æœŸæœ›: æ‰€æœ‰æƒé™éƒ½æœ‰æ‰è¿”å›true
    });

    it('åº”è¯¥æ”¯æŒORé€»è¾‘', () => {
      // è¾“å…¥: ['read:users', 'write:users'], operator: 'OR'
      // æœŸæœ›: æœ‰ä»»ä¸€æƒé™å°±è¿”å›true
    });
  });
});
```

### 2. è§’è‰²ç®¡ç†æµ‹è¯•

```typescript
describe('è§’è‰²ç®¡ç†', () => {
  describe('assignRole', () => {
    it('åº”è¯¥æˆåŠŸåˆ†é…è§’è‰²ç»™ç”¨æˆ·', () => {
      // åŠ¨ä½œ: assignRole(userId, 'editor')
      // æœŸæœ›: ç”¨æˆ·è·å¾—editorè§’è‰²
    });

    it('åº”è¯¥é˜²æ­¢é‡å¤åˆ†é…ç›¸åŒè§’è‰²', () => {
      // å‡†å¤‡: ç”¨æˆ·å·²æœ‰editorè§’è‰²
      // åŠ¨ä½œ: å†æ¬¡åˆ†é…editor
      // æœŸæœ›: è¿”å›å·²å­˜åœ¨æç¤º
    });

    it('åº”è¯¥å¤„ç†è§’è‰²å†²çª', () => {
      // å‡†å¤‡: viewerå’Œeditoräº’æ–¥
      // åŠ¨ä½œ: åŒæ—¶åˆ†é…ä¸¤ä¸ªè§’è‰²
      // æœŸæœ›: æ£€æµ‹å¹¶å¤„ç†å†²çª
    });

    it('åº”è¯¥è®°å½•è§’è‰²åˆ†é…å†å²', () => {
      // åŠ¨ä½œ: åˆ†é…è§’è‰²
      // æœŸæœ›: å®¡è®¡æ—¥å¿—è®°å½•æ“ä½œ
    });
  });

  describe('removeRole', () => {
    it('åº”è¯¥æ’¤é”€ç”¨æˆ·è§’è‰²', () => {
      // å‡†å¤‡: ç”¨æˆ·æœ‰adminè§’è‰²
      // åŠ¨ä½œ: removeRole(userId, 'admin')
      // æœŸæœ›: è§’è‰²è¢«ç§»é™¤
    });

    it('åº”è¯¥çº§è”åˆ é™¤ç›¸å…³æƒé™', () => {
      // å‡†å¤‡: è§’è‰²å…³è”å¤šä¸ªæƒé™
      // åŠ¨ä½œ: åˆ é™¤è§’è‰²
      // æœŸæœ›: ç›¸å…³æƒé™åŒæ—¶æ¸…ç†
    });
  });
});
```

### 3. ä¼ä¸šçº§æƒé™æµ‹è¯•

```typescript
describe('ä¼ä¸šæƒé™ç®¡ç†', () => {
  describe('ä¼ä¸šéš”ç¦»', () => {
    it('ä¸åŒä¼ä¸šçš„æƒé™åº”è¯¥å®Œå…¨éš”ç¦»', () => {
      // å‡†å¤‡: ä¸¤ä¸ªä¼ä¸šçš„åŒåè§’è‰²
      // æœŸæœ›: æƒé™äº’ä¸å½±å“
    });

    it('åº”è¯¥æ”¯æŒä¼ä¸šçº§é»˜è®¤æƒé™', () => {
      // å‡†å¤‡: ä¼ä¸šè®¾ç½®é»˜è®¤æƒé™
      // æœŸæœ›: æ–°ç”¨æˆ·è‡ªåŠ¨è·å¾—
    });
  });

  describe('éƒ¨é—¨æƒé™', () => {
    it('åº”è¯¥æ”¯æŒéƒ¨é—¨çº§æƒé™ç»§æ‰¿', () => {
      // å‡†å¤‡: éƒ¨é—¨æœ‰ç‰¹å®šæƒé™
      // æœŸæœ›: éƒ¨é—¨æˆå‘˜ç»§æ‰¿æƒé™
    });

    it('åº”è¯¥å¤„ç†éƒ¨é—¨å±‚çº§', () => {
      // å‡†å¤‡: å¤šçº§éƒ¨é—¨ç»“æ„
      // æœŸæœ›: æ­£ç¡®å¤„ç†æƒé™ä¼ é€’
    });
  });
});
```

### 4. æƒé™ç¼“å­˜æµ‹è¯•

```typescript
describe('æƒé™ç¼“å­˜', () => {
  it('åº”è¯¥ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„æƒé™', () => {
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢: ä»æ•°æ®åº“
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢: ä»ç¼“å­˜
    // æœŸæœ›: æ€§èƒ½æå‡
  });

  it('æƒé™æ›´æ–°åº”è¯¥åˆ·æ–°ç¼“å­˜', () => {
    // åŠ¨ä½œ: ä¿®æ”¹æƒé™
    // æœŸæœ›: ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ
  });

  it('åº”è¯¥è®¾ç½®åˆç†çš„TTL', () => {
    // æœŸæœ›: ç¼“å­˜5åˆ†é’Ÿåè¿‡æœŸ
  });
});
```

## ğŸ”§ Mockç­–ç•¥

### æ•°æ®åº“Mock

```typescript
const mockPrisma = {
  userRole: {
    findMany: jest.fn(),
    create: jest.fn(),
    delete: jest.fn()
  },
  permission: {
    findMany: jest.fn(),
    create: jest.fn()
  },
  role: {
    findUnique: jest.fn(),
    findMany: jest.fn()
  }
};
```

### Redisç¼“å­˜Mock

```typescript
const mockRedis = {
  get: jest.fn(),
  set: jest.fn(),
  del: jest.fn(),
  expire: jest.fn()
};
```

## ğŸ” è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### æ€§èƒ½è¾¹ç•Œ
- ç”¨æˆ·æœ‰1000+æƒé™æ—¶çš„æŸ¥è¯¢æ€§èƒ½
- æ‰¹é‡åˆ†é…10000ä¸ªæƒé™
- æ·±åº¦åµŒå¥—çš„è§’è‰²ç»§æ‰¿ï¼ˆ10å±‚+ï¼‰

### æ•°æ®è¾¹ç•Œ
- æƒé™åç§°æœ€å¤§é•¿åº¦
- ç‰¹æ®Šå­—ç¬¦å¤„ç†
- ç©ºå€¼å’Œnullå¤„ç†

### å¹¶å‘åœºæ™¯
- åŒæ—¶ä¿®æ”¹åŒä¸€ç”¨æˆ·æƒé™
- ç¼“å­˜ç«æ€æ¡ä»¶
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§

## âš¡ æ€§èƒ½è¦æ±‚

```typescript
describe('æ€§èƒ½æµ‹è¯•', () => {
  it('å•ä¸ªæƒé™æ£€æŸ¥ < 10ms', () => {
    // åŒ…å«ç¼“å­˜æŸ¥è¯¢
  });

  it('æ‰¹é‡æƒé™æ£€æŸ¥(100ä¸ª) < 50ms', () => {
    // æ‰¹é‡ä¼˜åŒ–
  });

  it('æƒé™åˆ†é… < 100ms', () => {
    // åŒ…å«æ•°æ®åº“å†™å…¥
  });
});
```

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] æ‰€æœ‰æƒé™æ£€æŸ¥å‡†ç¡®æ— è¯¯
- [ ] è§’è‰²åˆ†é…å’Œæ’¤é”€æ­£å¸¸
- [ ] æƒé™ç»§æ‰¿é€»è¾‘æ­£ç¡®
- [ ] ä¼ä¸šéš”ç¦»å®Œå…¨æœ‰æ•ˆ

### æ€§èƒ½éªŒæ”¶
- [ ] æŸ¥è¯¢å“åº”æ—¶é—´è¾¾æ ‡
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 90%
- [ ] æ”¯æŒ10000+ç”¨æˆ·è§„æ¨¡

### å®‰å…¨éªŒæ”¶
- [ ] æ— æƒé™æå‡æ¼æ´
- [ ] æ— æƒé™ç»•è¿‡å¯èƒ½
- [ ] å®¡è®¡æ—¥å¿—å®Œæ•´

## ğŸ“š æµ‹è¯•æ•°æ®

```typescript
export const testRoles = {
  admin: {
    id: 'role-admin',
    name: 'admin',
    permissions: ['*']
  },
  editor: {
    id: 'role-editor',
    name: 'editor',
    permissions: ['read:*', 'write:*']
  },
  viewer: {
    id: 'role-viewer',
    name: 'viewer',
    permissions: ['read:*']
  }
};

export const testPermissions = [
  'read:users',
  'write:users',
  'delete:users',
  'read:groups',
  'manage:enterprise',
  'admin:system'
];
```

## ğŸš€ å®æ–½è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | å·¥æ—¶ |
|------|------|------|
| Day 1 | åŸºç¡€æƒé™éªŒè¯æµ‹è¯• | 4h |
| Day 2 | è§’è‰²ç®¡ç†æµ‹è¯• | 4h |
| Day 3 | ä¼ä¸šçº§æƒé™æµ‹è¯• | 6h |
| Day 4 | ç¼“å­˜å’Œæ€§èƒ½æµ‹è¯• | 4h |
| Day 5 | é›†æˆæµ‹è¯•å’Œä¼˜åŒ– | 2h |

---

*åˆ›å»ºæ—¥æœŸ: 2025-01-12*
*è´Ÿè´£äºº: æƒé™æµ‹è¯•å°ç»„*